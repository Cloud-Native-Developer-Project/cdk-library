# Documentación del Paquete AWS S3 CDK

## Resumen

Este paquete Go proporciona una implementación integral de AWS CDK para crear y configurar buckets de Amazon S3 con seguridad de nivel empresarial, monitoreo y optimizaciones de rendimiento. Sigue las mejores prácticas de AWS y soporta una amplia gama de características de S3 a través de una interfaz única y flexible.

## Tabla de Contenidos

- [Instalación](#instalación)
- [Inicio Rápido](#inicio-rápido)
- [Opciones de Configuración](#opciones-de-configuración)
- [Características de Seguridad](#características-de-seguridad)
- [Gestión del Ciclo de Vida](#gestión-del-ciclo-de-vida)
- [Monitoreo y Logging](#monitoreo-y-logging)
- [Optimización de Rendimiento](#optimización-de-rendimiento)
- [Casos de Uso](#casos-de-uso)
- [Referencia de API](#referencia-de-api)
- [Mejores Prácticas](#mejores-prácticas)
- [Ejemplos](#ejemplos)

## Instalación

```bash
go get github.com/aws/aws-cdk-go/awscdk/v2
go get github.com/aws/aws-cdk-go/awscdk/v2/awss3
go get github.com/aws/constructs-go/constructs/v10
```

## Inicio Rápido

### Uso Básico

```go
package main

import (
    "tu-proyecto/s3" // Importa tu paquete S3
    "github.com/aws/aws-cdk-go/awscdk/v2"
    "github.com/aws/constructs-go/constructs/v10"
)

func main() {
    app := awscdk.NewApp(nil)
    stack := awscdk.NewStack(app, jsii.String("MiStack"), nil)

    // Crear bucket con configuración segura por defecto
    props := s3.GetDefaultProperties()
    props.BucketName = "mi-bucket-seguro-12345"

    bucket := s3.NewBucket(stack, "MiBucket", props)

    app.Synth(nil)
}
```

### Configuración Lista para Producción

```go
props := s3.S3Properties{
    // Configuración Básica
    BucketName:        "bucket-datos-produccion-12345",
    RemovalPolicy:     "retain",
    AutoDeleteObjects: false,

    // Seguridad (Estándares de Producción)
    PublicAccess:      false,
    Encryption:        "KMS",
    BucketKeyEnabled:  true,
    EnforceSSL:        true,
    MinimumTLSVersion: 1.3,

    // Protección de Datos
    Versioned:         true,
    ObjectLockEnabled: true,
    ObjectLockDefaultRetentionMode: "GOVERNANCE",
    ObjectLockDefaultRetentionDays: 30,

    // Optimización de Costos
    EnableIntelligentTiering: true,
    TransitionMinimumSize:    "ALL_STORAGE_CLASSES_128_K",

    // Monitoreo y Cumplimiento
    EnableAccessLogs:   true,
    AccessLogsPrefix:   "access-logs/",
    EventBridgeEnabled: true,
    EnableInventory:    true,
    EnableMetrics:      true,
}

bucket := s3.NewBucket(stack, "BucketProduccion", props)
```

## Opciones de Configuración

### Estructura S3Properties

La estructura `S3Properties` proporciona opciones de configuración organizadas por funcionalidad:

#### Configuración Básica

- **BucketName**: Nombre único global del bucket (requerido)
- **RemovalPolicy**: Política de eliminación (`retain`, `destroy`, `retain_on_update_or_delete`)
- **AutoDeleteObjects**: Eliminar automáticamente objetos cuando se destruye el bucket

#### Configuración de Seguridad

- **PublicAccess**: Permitir acceso público para sitios web estáticos
- **Encryption**: Tipo de encriptación (`S3_MANAGED`, `KMS`, `DSSE`)
- **BucketKeyEnabled**: Reducir llamadas a la API de KMS para optimización de costos
- **EnforceSSL**: Forzar acceso solo HTTPS
- **MinimumTLSVersion**: Versión mínima de TLS (1.2 o 1.3)

#### Versionado y Cumplimiento

- **Versioned**: Habilitar versionado de objetos
- **ObjectLockEnabled**: Habilitar Object Lock para cumplimiento
- **ObjectLockDefaultRetentionMode**: `GOVERNANCE` o `COMPLIANCE`
- **ObjectLockDefaultRetentionDays**: Período de retención en días

#### Gestión del Ciclo de Vida

- **EnableIntelligentTiering**: Optimización automática de clase de almacenamiento
- **LifecycleRules**: Reglas de transición personalizadas
- **TransitionMinimumSize**: Tamaño mínimo de objeto para transiciones

#### Monitoreo y Logging

- **EnableAccessLogs**: Logging de acceso del servidor
- **AccessLogsBucket**: Bucket de destino para logs de acceso
- **AccessLogsPrefix**: Prefijo para archivos de log
- **EventBridgeEnabled**: Enviar eventos a EventBridge
- **EnableInventory**: Reportes de inventario de S3
- **EnableMetrics**: Métricas de solicitudes de CloudWatch

#### Rendimiento y Red

- **TransferAcceleration**: Uploads globales más rápidos
- **EnableCORS**: Cross-Origin Resource Sharing
- **CORSAllowedOrigins/Methods/Headers**: Configuración CORS

#### Hosting de Sitios Web

- **WebsiteEnabled**: Hosting de sitio web estático
- **WebsiteIndexDocument**: Documento índice (ej. "index.html")
- **WebsiteErrorDocument**: Documento de error (ej. "404.html")

## Características de Seguridad

### Opciones de Encriptación

#### Encriptación Gestionada por S3 (Por Defecto)

```go
props.Encryption = "S3_MANAGED"
```

- Encriptación del lado del servidor con claves gestionadas por S3
- Sin costo adicional
- Rotación automática de claves

#### Encriptación KMS

```go
props.Encryption = "KMS"
props.BucketKeyEnabled = true // Reducir costos de API KMS
```

- Encriptación con AWS Key Management Service
- Control granular sobre claves
- Auditoría completa de uso de claves
- **BucketKeyEnabled** reduce costos al usar una clave intermedia

#### Encriptación DSSE (Dual-Layer Server-Side)

```go
props.Encryption = "DSSE"
```

- Doble capa de encriptación
- Cumple estándares de seguridad más estrictos
- Para aplicaciones con requisitos de cumplimiento elevados

### Controles de Acceso Público

#### Bloqueo Total (Recomendado)

```go
props.PublicAccess = false
```

- Bloquea todo acceso público
- Máximo nivel de seguridad
- Ideal para datos privados

#### Acceso Público Controlado

```go
props.PublicAccess = true
```

- Permite políticas de bucket públicas
- Mantiene bloqueo de ACLs públicas
- Para hosting de sitios web estáticos

### SSL/TLS y Seguridad de Transporte

```go
props.EnforceSSL = true
props.MinimumTLSVersion = 1.3
```

- Fuerza conexiones HTTPS únicamente
- Establece versión mínima de TLS
- Rechaza conexiones HTTP inseguras

## Gestión del Ciclo de Vida

### Intelligent Tiering Automático

```go
props.EnableIntelligentTiering = true
```

**¿Qué hace?**

- Monitorea automáticamente patrones de acceso
- Mueve objetos entre clases de almacenamiento
- Optimiza costos sin intervención manual

**Transiciones automáticas:**

- **Frequent Access** → **Infrequent Access** (30 días)
- **Infrequent Access** → **Archive Access** (90 días)
- **Archive Access** → **Deep Archive Access** (180 días)

**Beneficios:**

- Ahorro de hasta 68% en costos de almacenamiento
- Sin impacto en rendimiento
- No hay cargos por recuperación

### Reglas de Lifecycle Personalizadas

```go
lifecycleRule := &awss3.LifecycleRule{
    Id: jsii.String("TransitionRule"),
    Enabled: jsii.Bool(true),
    Transitions: []*awss3.Transition{
        {
            StorageClass: awss3.StorageClass_INFREQUENT_ACCESS(),
            TransitionAfter: awscdk.Duration_Days(jsii.Number(30)),
        },
        {
            StorageClass: awss3.StorageClass_GLACIER(),
            TransitionAfter: awscdk.Duration_Days(jsii.Number(90)),
        },
    },
    Expiration: awscdk.Duration_Days(jsii.Number(2555)), // 7 años
}

props.LifecycleRules = []*awss3.LifecycleRule{lifecycleRule}
```

### Tamaño Mínimo para Transiciones

```go
props.TransitionMinimumSize = "ALL_STORAGE_CLASSES_128_K"
```

- Evita cargos adicionales en objetos pequeños
- Clases de almacenamiento como IA y Glacier tienen cargos mínimos
- Objetos menores a 128KB no se transicionan

## Monitoreo y Logging

### Server Access Logs

```go
props.EnableAccessLogs = true
props.AccessLogsBucket = "mi-bucket-logs"
props.AccessLogsPrefix = "access-logs/año/mes/día/"
```

**Información capturada:**

- IP del cliente
- Hora de la solicitud
- Acción realizada (GET, PUT, DELETE)
- Código de estado HTTP
- Bytes transferidos
- User-Agent

**Casos de uso:**

- Auditoría de seguridad
- Análisis de patrones de uso
- Detección de anomalías
- Cumplimiento normativo

### CloudWatch Metrics

```go
props.EnableMetrics = true
props.MetricsId = "ProductionMetrics"
props.MetricsPrefix = "critical-data/" // Solo monitorear objetos críticos
props.MetricsTagFilters = map[string]string{
    "Environment": "Production",
    "Team": "DataEngineering",
}
```

**Métricas disponibles:**

- **Requests**: Número de solicitudes por minuto
- **Data Transfer**: Bytes transferidos
- **4xx/5xx Errors**: Errores de cliente y servidor
- **First Byte Latency**: Tiempo de respuesta

**Filtros disponibles:**

- Por prefijo de objetos
- Por tags de objetos
- Configuraciones múltiples por bucket

### EventBridge Integration

```go
props.EventBridgeEnabled = true
```

**Eventos capturados:**

- Object Created (PUT, POST, COPY)
- Object Removed (DELETE)
- Object Restore (desde Glacier)
- Lifecycle Transitions

**Casos de uso:**

- Procesamiento automático de archivos
- Notificaciones en tiempo real
- Integración con Lambda, SQS, SNS
- Pipelines de datos event-driven

### S3 Inventory

```go
props.EnableInventory = true
```

**Reportes generados:**

- Lista completa de objetos
- Metadatos de objetos (tamaño, última modificación)
- Estado de encriptación
- Clases de almacenamiento
- Tags de objetos

**Formatos disponibles:**

- CSV
- Apache Parquet (para análisis con Athena)

**Frecuencia:**

- Diaria o semanal
- Reportes incrementales disponibles

## Optimización de Rendimiento

### Transfer Acceleration

```go
props.TransferAcceleration = true
```

**¿Cómo funciona?**

- Utiliza CloudFront edge locations
- Enruta tráfico por la red global de AWS
- Acelera uploads desde ubicaciones distantes

**Beneficios:**

- Mejora de velocidad de 50-500% para uploads globales
- Especialmente efectivo para archivos grandes
- Sin cambios en el código de aplicación

**URL de ejemplo:**

```
https://mi-bucket.s3-accelerate.amazonaws.com/archivo.zip
```

### CORS Configuration

```go
props.EnableCORS = true
props.CORSAllowedOrigins = []string{
    "https://miapp.com",
    "https://*.miapp.com",
}
props.CORSAllowedMethods = []string{"GET", "POST", "PUT"}
props.CORSAllowedHeaders = []string{
    "Content-Type",
    "Authorization",
    "x-amz-meta-*",
}
```

**Casos de uso:**

- Aplicaciones web SPA (Single Page Applications)
- Uploads directos desde navegador
- APIs REST con recursos S3
- Integración con CDNs

## Casos de Uso

### 1. Almacenamiento de Datos Empresariales

```go
props := s3.S3Properties{
    BucketName: "datos-empresariales-prod",

    // Máxima seguridad
    Encryption: "KMS",
    EnforceSSL: true,
    MinimumTLSVersion: 1.3,
    PublicAccess: false,

    // Protección de datos
    Versioned: true,
    ObjectLockEnabled: true,
    ObjectLockDefaultRetentionMode: "COMPLIANCE",
    ObjectLockDefaultRetentionDays: 2555, // 7 años

    // Optimización de costos
    EnableIntelligentTiering: true,

    // Auditoría completa
    EnableAccessLogs: true,
    EnableInventory: true,
    EnableMetrics: true,
    EventBridgeEnabled: true,

    // Conservación permanente
    RemovalPolicy: "retain",
}
```

### 2. Hosting de Sitio Web Estático

```go
props := s3.S3Properties{
    BucketName: "mi-sitio-web-estatico",

    // Configuración web
    WebsiteEnabled: true,
    WebsiteIndexDocument: "index.html",
    WebsiteErrorDocument: "404.html",

    // Acceso público controlado
    PublicAccess: true, // Solo para sitios web

    // CORS para APIs
    EnableCORS: true,
    CORSAllowedOrigins: []string{"*"},
    CORSAllowedMethods: []string{"GET", "HEAD"},

    // Aceleración global
    TransferAcceleration: true,

    // Seguridad básica
    EnforceSSL: true,
    Encryption: "S3_MANAGED",

    // Desarrollo: puede eliminarse
    RemovalPolicy: "destroy",
    AutoDeleteObjects: true,
}
```

### 3. Data Lake Analytics

```go
props := s3.S3Properties{
    BucketName: "data-lake-analytics-prod",

    // Optimización de costos agresiva
    EnableIntelligentTiering: true,
    TransitionMinimumSize: "ALL_STORAGE_CLASSES_128_K",

    // Particionado por fecha
    // Lifecycle rules personalizadas para particiones antiguas

    // Inventario para catálogo de datos
    EnableInventory: true,

    // EventBridge para procesamiento automático
    EventBridgeEnabled: true,

    // Métricas por prefijo de datos
    EnableMetrics: true,
    MetricsPrefix: "year=2024/", // Solo datos actuales

    // Seguridad estándar
    Encryption: "KMS",
    Versioned: true,

    // Logs para auditoría
    EnableAccessLogs: true,
    AccessLogsPrefix: "audit-logs/",
}
```

### 4. Backup y Disaster Recovery

```go
props := s3.S3Properties{
    BucketName: "backup-disaster-recovery",

    // Máxima durabilidad
    Versioned: true,
    ObjectLockEnabled: true,
    ObjectLockDefaultRetentionMode: "GOVERNANCE",
    ObjectLockDefaultRetentionDays: 90,

    // Transiciones automáticas para reducir costos
    EnableIntelligentTiering: true,

    // Replicación cross-region
    ReplicationEnabled: true,
    ReplicationDestination: "arn:aws:s3:::backup-dr-replica",
    ReplicationStorageClass: "GLACIER",

    // Monitoreo completo
    EnableMetrics: true,
    EnableInventory: true,
    EventBridgeEnabled: true,

    // Nunca eliminar
    RemovalPolicy: "retain",
}
```

### 5. Aplicación de Streaming de Media

```go
props := s3.S3Properties{
    BucketName: "streaming-media-content",

    // Máximo rendimiento
    TransferAcceleration: true,

    // CORS para reproductores web
    EnableCORS: true,
    CORSAllowedOrigins: []string{
        "https://player.miapp.com",
        "https://*.cdn.miapp.com",
    },
    CORSAllowedMethods: []string{"GET", "HEAD"},

    // Optimización por tipo de contenido
    EnableIntelligentTiering: true,
    // Lifecycle personalizado para contenido antiguo

    // Métricas por tipo de contenido
    EnableMetrics: true,
    MetricsPrefix: "videos/", // Solo videos

    // EventBridge para procesamiento automático
    EventBridgeEnabled: true,

    // Seguridad estándar
    Encryption: "S3_MANAGED",
    EnforceSSL: true,
}
```

## Referencia de API

### Función Principal

#### `NewBucket(scope constructs.Construct, id string, props S3Properties) awss3.Bucket`

Crea un nuevo bucket S3 con la configuración especificada.

**Parámetros:**

- `scope`: El scope padre del construct
- `id`: Identificador único del construct
- `props`: Configuración del bucket (S3Properties)

**Retorna:**

- Instancia del bucket S3 creado

### Funciones de Utilidad

#### `GetDefaultProperties() S3Properties`

Retorna una configuración segura por defecto siguiendo las mejores prácticas de AWS.

**Configuración por defecto:**

- Encriptación S3_MANAGED habilitada
- SSL forzado con TLS 1.2 mínimo
- Acceso público bloqueado
- Versionado habilitado
- Intelligent Tiering habilitado
- Política de retención segura

#### `configureRemovalPolicy(policy string) awscdk.RemovalPolicy`

Convierte string a enum de política de eliminación.

**Opciones:**

- `"retain"`: Mantiene el bucket al eliminar el stack
- `"destroy"`: Elimina el bucket con el stack
- `"retain_on_update_or_delete"`: Mantiene en actualizaciones y eliminaciones

#### `configureEncryption(encType string) awss3.BucketEncryption`

Configura el tipo de encriptación.

**Tipos soportados:**

- `"S3_MANAGED"`: Encriptación gestionada por S3
- `"KMS"`: Encriptación con AWS KMS
- `"DSSE"`: Encriptación dual-layer

#### `configureObjectLockRetention(mode string, days int32) awss3.ObjectLockRetention`

Configura retención de Object Lock.

**Modos:**

- `"GOVERNANCE"`: Permite eliminación con permisos especiales
- `"COMPLIANCE"`: Prohibe eliminación durante período de retención

## Mejores Prácticas

### Seguridad

1. **Siempre usar encriptación**

   ```go
   props.Encryption = "KMS" // Para datos sensibles
   props.BucketKeyEnabled = true // Para reducir costos
   ```

2. **Forzar SSL/TLS**

   ```go
   props.EnforceSSL = true
   props.MinimumTLSVersion = 1.3 // TLS más reciente
   ```

3. **Bloquear acceso público por defecto**

   ```go
   props.PublicAccess = false // Solo habilitar para sitios web
   ```

4. **Habilitar versionado**
   ```go
   props.Versioned = true // Protección contra eliminación accidental
   ```

### Costos

1. **Usar Intelligent Tiering**

   ```go
   props.EnableIntelligentTiering = true // Ahorro automático
   ```

2. **Configurar tamaño mínimo**

   ```go
   props.TransitionMinimumSize = "ALL_STORAGE_CLASSES_128_K"
   ```

3. **Lifecycle rules personalizadas**
   ```go
   // Mover a Glacier después de 90 días
   // Eliminar después de 7 años (cumplimiento)
   ```

### Monitoreo

1. **Habilitar logs de acceso en producción**

   ```go
   props.EnableAccessLogs = true
   props.AccessLogsBucket = "bucket-logs-separado"
   ```

2. **Configurar métricas para buckets críticos**

   ```go
   props.EnableMetrics = true
   props.MetricsPrefix = "critical-data/"
   ```

3. **EventBridge para automatización**
   ```go
   props.EventBridgeEnabled = true // Para pipelines automáticos
   ```

### Rendimiento

1. **Transfer Acceleration para usuarios globales**

   ```go
   props.TransferAcceleration = true
   ```

2. **CORS adecuado para aplicaciones web**
   ```go
   props.EnableCORS = true
   // Especificar orígenes específicos, evitar "*" en producción
   ```

### Naming Conventions

1. **Nombres descriptivos y únicos**

   ```go
   // Bueno
   props.BucketName = "mi-empresa-logs-prod-us-east-1-2024"

   // Malo
   props.BucketName = "bucket1"
   ```

2. **Incluir entorno y región**
   ```go
   props.BucketName = fmt.Sprintf("mi-app-%s-%s", environment, region)
   ```

### Cumplimiento

1. **Object Lock para retención regulatoria**

   ```go
   props.ObjectLockEnabled = true
   props.ObjectLockDefaultRetentionMode = "COMPLIANCE"
   props.ObjectLockDefaultRetentionDays = 2555 // 7 años
   ```

2. **Inventario para auditoría**
   ```go
   props.EnableInventory = true // Para reportes de cumplimiento
   ```

## Ejemplos Avanzados

### Bucket con Replicación Cross-Region

```go
// Bucket primario
primary := s3.S3Properties{
    BucketName: "datos-primarios-us-east-1",
    ReplicationEnabled: true,
    ReplicationDestination: "arn:aws:s3:::datos-replica-us-west-2",
    ReplicationStorageClass: "STANDARD_IA",
    Versioned: true, // Requerido para replicación
}

// Bucket replica (en otra región)
replica := s3.S3Properties{
    BucketName: "datos-replica-us-west-2",
    Versioned: true,
    EnableIntelligentTiering: true, // Optimizar costos en replica
}
```

### Configuración Multi-Tenant

```go
func CreateTenantBucket(tenantId string) s3.S3Properties {
    return s3.S3Properties{
        BucketName: fmt.Sprintf("tenant-%s-data", tenantId),

        // Aislamiento de seguridad por tenant
        Encryption: "KMS",
        // KMS key específica por tenant

        // Métricas por tenant
        EnableMetrics: true,
        MetricsId: fmt.Sprintf("tenant-%s-metrics", tenantId),

        // Logs segregados
        EnableAccessLogs: true,
        AccessLogsPrefix: fmt.Sprintf("tenant-%s/", tenantId),

        // Configuración estándar
        Versioned: true,
        EnableIntelligentTiering: true,
        EnforceSSL: true,
    }
}
```

### Pipeline de Procesamiento de Datos

```go
// Bucket de ingesta de datos raw
ingestion := s3.S3Properties{
    BucketName: "data-ingestion-raw",
    EventBridgeEnabled: true, // Trigger procesamiento
    EnableMetrics: true,

    // Lifecycle: mover a IA después de 7 días
    // Los datos raw se procesan rápidamente
}

// Bucket de datos procesados
processed := s3.S3Properties{
    BucketName: "data-processed-analytics",
    EnableIntelligentTiering: true,
    EnableInventory: true, // Para catálogo de datos

    // Particionado por fecha para analytics
    MetricsPrefix: "year=2024/month=12/",
}

// Bucket de archivos
archive := s3.S3Properties{
    BucketName: "data-archive-longterm",
    EnableIntelligentTiering: true,

    // Lifecycle agresivo hacia Deep Archive
    TransitionMinimumSize: "ALL_STORAGE_CLASSES_128_K",
}
```

---

## Conclusión

Este paquete S3 CDK proporciona una solución robusta y flexible para la gestión de buckets S3 en AWS. Implementa las mejores prácticas de seguridad, optimización de costos y rendimiento, permitiendo configuraciones desde simples hasta complejas arquitecturas empresariales.

La documentación cubre todos los aspectos necesarios para utilizar el paquete de manera efectiva, desde configuraciones básicas hasta casos de uso avanzados y mejores prácticas de la industria.
