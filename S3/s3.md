# Documentación del Paquete AWS S3 CDK

## Resumen

Este paquete Go proporciona una implementación integral de AWS CDK para crear y configurar buckets de Amazon S3 con seguridad de nivel empresarial, monitoreo y optimizaciones de rendimiento. Sigue las mejores prácticas de AWS y soporta una amplia gama de características de S3 a través de una interfaz única y flexible.

## Tabla de Contenidos

- [Instalación](#instalación)
- [Inicio Rápido](#inicio-rápido)
- [Opciones de Configuración](#opciones-de-configuración)
- [Características de Seguridad](#características-de-seguridad)
- [Gestión del Ciclo de Vida](#gestión-del-ciclo-de-vida)
- [Monitoreo y Logging](#monitoreo-y-logging)
- [Optimización de Rendimiento](#optimización-de-rendimiento)
- [Casos de Uso](#casos-de-uso)
- [Referencia de API](#referencia-de-api)
- [Mejores Prácticas](#mejores-prácticas)
- [Ejemplos](#ejemplos)

## Instalación

```bash
go get github.com/aws/aws-cdk-go/awscdk/v2
go get github.com/aws/aws-cdk-go/awscdk/v2/awss3
go get github.com/aws/constructs-go/constructs/v10
```

## Inicio Rápido

### Uso Básico

```go
package main

import (
    "tu-proyecto/s3" // Importa tu paquete S3
    "github.com/aws/aws-cdk-go/awscdk/v2"
    "github.com/aws/constructs-go/constructs/v10"
    "github.com/aws/jsii-runtime-go"
)

func main() {
    app := awscdk.NewApp(nil)
    stack := awscdk.NewStack(app, jsii.String("MiStack"), nil)

    // Crear bucket con configuración segura por defecto
    props := s3.GetDefaultProperties()
    props.BucketName = "mi-bucket-seguro-12345"

    bucket := s3.NewBucket(stack, "MiBucket", props)

    app.Synth(nil)
}
```

### Configuración Lista para Producción

```go
props := s3.S3Properties{
    // Configuración Básica
    BucketName:        "bucket-datos-produccion-12345",
    RemovalPolicy:     "retain",
    AutoDeleteObjects: false,

    // Seguridad (Estándares de Producción)
    PublicAccess:      false,
    Encryption:        "KMS",
    BucketKeyEnabled:  true,
    EnforceSSL:        true,
    MinimumTLSVersion: 1.3,

    // Protección de Datos
    Versioned:         true,
    ObjectLockEnabled: true,
    ObjectLockDefaultRetentionMode: "GOVERNANCE",
    ObjectLockDefaultRetentionDays: 30,

    // Optimización de Costos
    EnableIntelligentTiering: true,
    TransitionMinimumSize:    "ALL_STORAGE_CLASSES_128_K",

    // Monitoreo y Cumplimiento
    EnableAccessLogs:   true,
    AccessLogsPrefix:   "access-logs/",
    EventBridgeEnabled: true,
    EnableInventory:    true,
    EnableMetrics:      true,
}

bucket := s3.NewBucket(stack, "BucketProduccion", props)
```

## Opciones de Configuración

### Estructura S3Properties

La estructura `S3Properties` proporciona opciones de configuración organizadas por funcionalidad:

#### Configuración Básica

- **BucketName**: Nombre único global del bucket (requerido)
- **RemovalPolicy**: Política de eliminación (`retain`, `destroy`, `retain_on_update_or_delete`)
- **AutoDeleteObjects**: Eliminar automáticamente objetos cuando se destruye el bucket

#### Configuración de Seguridad

- **PublicAccess**: Permitir acceso público para sitios web estáticos
- **Encryption**: Tipo de encriptación (`S3_MANAGED`, `KMS`, `DSSE`)
- **BucketKeyEnabled**: Reducir llamadas a la API de KMS para optimización de costos
- **EnforceSSL**: Forzar acceso solo HTTPS
- **MinimumTLSVersion**: Versión mínima de TLS (1.2 o 1.3)

#### Versionado y Cumplimiento

- **Versioned**: Habilitar versionado de objetos
- **ObjectLockEnabled**: Habilitar Object Lock para cumplimiento
- **ObjectLockDefaultRetentionMode**: `GOVERNANCE` o `COMPLIANCE`
- **ObjectLockDefaultRetentionDays**: Período de retención en días

#### Gestión del Ciclo de Vida

- **EnableIntelligentTiering**: Optimización automática de clase de almacenamiento
- **LifecycleRules**: Reglas de transición personalizadas
- **TransitionMinimumSize**: Tamaño mínimo de objeto para transiciones

#### Monitoreo y Logging

- **EnableAccessLogs**: Logging de acceso del servidor
- **AccessLogsBucket**: Bucket de destino para logs de acceso
- **AccessLogsPrefix**: Prefijo para archivos de log
- **EventBridgeEnabled**: Enviar eventos a EventBridge
- **EnableInventory**: Reportes de inventario de S3
- **EnableMetrics**: Métricas de solicitudes de CloudWatch

#### Rendimiento y Red

- **TransferAcceleration**: Uploads globales más rápidos
- **EnableCORS**: Cross-Origin Resource Sharing
- **CORSAllowedOrigins/Methods/Headers**: Configuración CORS

#### Hosting de Sitios Web

- **WebsiteEnabled**: Hosting de sitio web estático
- **WebsiteIndexDocument**: Documento índice (ej. "index.html")
- **WebsiteErrorDocument**: Documento de error (ej. "404.html")

## Características de Seguridad

### Opciones de Encriptación

#### Encriptación Gestionada por S3 (Por Defecto)

```go
props.Encryption = "S3_MANAGED"
```

- Encriptación del lado del servidor con claves gestionadas por S3
- Sin costo adicional
- Rotación automática de claves

#### Encriptación KMS

```go
props.Encryption = "KMS"
props.BucketKeyEnabled = true // Reducir costos de API KMS
```

- Encriptación con AWS Key Management Service
- Control granular sobre claves
- Auditoría completa de uso de claves
- **BucketKeyEnabled** reduce costos al usar una clave intermedia

#### Encriptación DSSE (Dual-Layer Server-Side)

```go
props.Encryption = "DSSE"
```

- Doble capa de encriptación
- Cumple estándares de seguridad más estrictos
- Para aplicaciones con requisitos de cumplimiento elevados

### Controles de Acceso Público

#### Bloqueo Total (Recomendado)

```go
props.PublicAccess = false
```

- Bloquea todo acceso público
- Máximo nivel de seguridad
- Ideal para datos privados

#### Acceso Público Controlado

```go
props.PublicAccess = true
```

- Permite políticas de bucket públicas
- Mantiene bloqueo de ACLs públicas
- Para hosting de sitios web estáticos

### SSL/TLS y Seguridad de Transporte

```go
props.EnforceSSL = true
props.MinimumTLSVersion = 1.3
```

- Fuerza conexiones HTTPS únicamente
- Establece versión mínima de TLS
- Rechaza conexiones HTTP inseguras

## Gestión del Ciclo de Vida

### Intelligent Tiering Automático

```go
props.EnableIntelligentTiering = true
```

**¿Qué hace?**

- Monitorea automáticamente patrones de acceso
- Mueve objetos entre clases de almacenamiento
- Optimiza costos sin intervención manual

**Transiciones automáticas:**

- **Frequent Access** → **Infrequent Access** (30 días)
- **Infrequent Access** → **Archive Access** (90 días)
- **Archive Access** → **Deep Archive Access** (180 días)

**Beneficios:**

- Ahorro de hasta 68% en costos de almacenamiento
- Sin impacto en rendimiento
- No hay cargos por recuperación

### Reglas de Lifecycle Personalizadas

```go
// Estructura correcta para CDK Go v2
lifecycleRule := &awss3.LifecycleRule{
    Id:      jsii.String("TransitionRule"),
    Enabled: jsii.Bool(true),
    Prefix:  jsii.String("data/"), // Filtro por prefijo
    Transitions: &[]*awss3.Transition{
        {
            StorageClass:    awss3.StorageClass_INFREQUENT_ACCESS(),
            TransitionAfter: awscdk.Duration_Days(jsii.Number(30)),
        },
        {
            StorageClass:    awss3.StorageClass_GLACIER(),
            TransitionAfter: awscdk.Duration_Days(jsii.Number(90)),
        },
        {
            StorageClass:    awss3.StorageClass_DEEP_ARCHIVE(),
            TransitionAfter: awscdk.Duration_Days(jsii.Number(365)),
        },
    },
    Expiration: awscdk.Duration_Days(jsii.Number(2555)), // 7 años
}

props.LifecycleRules = []*awss3.LifecycleRule{lifecycleRule}
```

**Puntos Clave:**

- **StorageClass**: Usar funciones con `()` (ej. `awss3.StorageClass_GLACIER()`)
- **Duration**: Usar `awscdk.Duration_Days()` para expiraciones
- **Estructura plana**: Usar campos directos, no estructuras anidadas

### Versiones No Actuales

```go
// Limpieza de versiones anteriores
lifecycleRule := &awss3.LifecycleRule{
    Id:      jsii.String("VersionCleanup"),
    Enabled: jsii.Bool(true),
    NoncurrentVersionExpiration: awscdk.Duration_Days(jsii.Number(30)),
}
```

### Tamaño Mínimo para Transiciones

```go
props.TransitionMinimumSize = "ALL_STORAGE_CLASSES_128_K"
```

- Evita cargos adicionales en objetos pequeños
- Clases de almacenamiento como IA y Glacier tienen cargos mínimos
- Objetos menores a 128KB no se transicionan

## Monitoreo y Logging

### Server Access Logs

```go
props.EnableAccessLogs = true
props.AccessLogsBucket = "mi-bucket-logs"
props.AccessLogsPrefix = "access-logs/año/mes/día/"
```

**Información capturada:**

- IP del cliente
- Hora de la solicitud
- Acción realizada (GET, PUT, DELETE)
- Código de estado HTTP
- Bytes transferidos
- User-Agent

**Casos de uso:**

- Auditoría de seguridad
- Análisis de patrones de uso
- Detección de anomalías
- Cumplimiento normativo

### CloudWatch Metrics

```go
props.EnableMetrics = true
props.MetricsId = "ProductionMetrics"
props.MetricsPrefix = "critical-data/" // Solo monitorear objetos críticos
props.MetricsTagFilters = map[string]string{
    "Environment": "Production",
    "Team": "DataEngineering",
}
```

**Métricas disponibles:**

- **Requests**: Número de solicitudes por minuto
- **Data Transfer**: Bytes transferidos
- **4xx/5xx Errors**: Errores de cliente y servidor
- **First Byte Latency**: Tiempo de respuesta

**Filtros disponibles:**

- Por prefijo de objetos
- Por tags de objetos
- Configuraciones múltiples por bucket

### EventBridge Integration

```go
props.EventBridgeEnabled = true
```

**Eventos capturados:**

- Object Created (PUT, POST, COPY)
- Object Removed (DELETE)
- Object Restore (desde Glacier)
- Lifecycle Transitions

**Casos de uso:**

- Procesamiento automático de archivos
- Notificaciones en tiempo real
- Integración con Lambda, SQS, SNS
- Pipelines de datos event-driven

### S3 Inventory

```go
props.EnableInventory = true
```

**Reportes generados:**

- Lista completa de objetos
- Metadatos de objetos (tamaño, última modificación)
- Estado de encriptación
- Clases de almacenamiento
- Tags de objetos

**Formatos disponibles:**

- CSV
- Apache Parquet (para análisis con Athena)

**Frecuencia:**

- Diaria o semanal
- Reportes incrementales disponibles

## Optimización de Rendimiento

### Transfer Acceleration

```go
props.TransferAcceleration = true
```

**¿Cómo funciona?**

- Utiliza CloudFront edge locations
- Enruta tráfico por la red global de AWS
- Acelera uploads desde ubicaciones distantes

**Beneficios:**

- Mejora de velocidad de 50-500% para uploads globales
- Especialmente efectivo para archivos grandes
- Sin cambios en el código de aplicación

**URL de ejemplo:**

```
https://mi-bucket.s3-accelerate.amazonaws.com/archivo.zip
```

### CORS Configuration

```go
props.EnableCORS = true
props.CORSAllowedOrigins = []string{
    "https://miapp.com",
    "https://*.miapp.com",
}
props.CORSAllowedMethods = []string{"GET", "POST", "PUT"}
props.CORSAllowedHeaders = []string{
    "Content-Type",
    "Authorization",
    "x-amz-meta-*",
}
```

**Casos de uso:**

- Aplicaciones web SPA (Single Page Applications)
- Uploads directos desde navegador
- APIs REST con recursos S3
- Integración con CDNs

## Casos de Uso

### 1. Datos Empresariales - `GetEnterpriseDataProperties()`

```go
props := s3.GetEnterpriseDataProperties()
props.BucketName = "datos-empresariales-prod-12345"

// Configuración preestablecida:
// - Encryption: "KMS"
// - EnforceSSL: true, MinimumTLSVersion: 1.3
// - ObjectLock: COMPLIANCE mode, 7 años
// - Intelligent Tiering: habilitado
// - Monitoreo completo: logs, inventory, metrics, EventBridge
```

### 2. Sitio Web Estático - `GetStaticWebsiteProperties()`

```go
props := s3.GetStaticWebsiteProperties()
props.BucketName = "mi-sitio-web-12345"

// Configuración preestablecida:
// - WebsiteEnabled: true
// - PublicAccess: true (controlado)
// - CORS: habilitado para "*" origins
// - Lifecycle: limpieza de versiones (30 días)
```

**Nota importante**: Para producción, usa `GetCloudFrontOriginProperties()` en su lugar.

### 3. Origen CloudFront - `GetCloudFrontOriginProperties()` (Recomendado)

```go
props := s3.GetCloudFrontOriginProperties()
props.BucketName = "cloudfront-origin-12345"

// Configuración preestablecida:
// - PublicAccess: false (CloudFront usa OAC)
// - EnforceSSL: true
// - EventBridge: habilitado para deployments
// - Lifecycle: limpieza rápida de versiones (7 días)
```

### 4. Data Lake - `GetDataLakeProperties()`

```go
props := s3.GetDataLakeProperties()
props.BucketName = "data-lake-analytics-12345"

// Configuración preestablecida:
// - Encryption: "KMS" para compliance
// - Intelligent Tiering: habilitado
// - Lifecycle rules específicas para "raw-data/" y "processed-data/"
// - Monitoreo completo con métricas por prefijo
```

### 5. Backups - `GetBackupProperties()`

```go
props := s3.GetBackupProperties()
props.BucketName = "backup-disaster-recovery-12345"

// Configuración preestablecida:
// - ObjectLock: GOVERNANCE mode, 90 días mínimo
// - Lifecycle agresivo: IA→Glacier→Deep Archive
// - Retención total: 7 años
// - Monitoreo completo para auditoría
```

### 6. Media Streaming - `GetMediaStreamingProperties()`

```go
props := s3.GetMediaStreamingProperties()
props.BucketName = "streaming-media-12345"

// Configuración preestablecida:
// - CORS específico para dominios de streaming
// - Lifecycle optimizado para contenido multimedia
// - Métricas en prefijo "videos/"
// - EventBridge para procesamiento automático
```

### 7. Desarrollo - `GetDevelopmentProperties()`

```go
props := s3.GetDevelopmentProperties()
props.BucketName = "dev-testing-12345"

// Configuración preestablecida:
// - RemovalPolicy: "destroy" para fácil limpieza
// - Seguridad mínima para simplicidad
// - CORS permisivo para desarrollo
// - Lifecycle: auto-limpieza después de 30 días
```

## Referencia de API

### Función Principal

#### `NewBucket(scope constructs.Construct, id string, props S3Properties) awss3.Bucket`

Crea un nuevo bucket S3 con la configuración especificada.

**Parámetros:**

- `scope`: El scope padre del construct
- `id`: Identificador único del construct
- `props`: Configuración del bucket (S3Properties)

**Retorna:**

- Instancia del bucket S3 creado

### Funciones de Utilidad Preconfiguradas

#### `GetDefaultProperties() S3Properties`

Retorna una configuración segura por defecto siguiendo las mejores prácticas de AWS.

#### `GetEnterpriseDataProperties() S3Properties`

Configuración optimizada para datos empresariales críticos con máxima seguridad.

#### `GetStaticWebsiteProperties() S3Properties`

Configuración para hosting web estático directo (usar solo para desarrollo).

#### `GetCloudFrontOriginProperties() S3Properties`

**Configuración RECOMENDADA** para sitios web usando CloudFront + S3 con OAC.

#### `GetDataLakeProperties() S3Properties`

Configuración optimizada para analytics de big data y data science.

#### `GetBackupProperties() S3Properties`

Configuración para backups y disaster recovery con retención regulatoria.

#### `GetMediaStreamingProperties() S3Properties`

Configuración optimizada para streaming de contenido multimedia.

#### `GetDevelopmentProperties() S3Properties`

Configuración minimalista para entornos de desarrollo y testing.

### Funciones de Configuración Interna

#### `configureRemovalPolicy(policy string) awscdk.RemovalPolicy`

Convierte string a enum de política de eliminación.

#### `configureEncryption(encType string) awss3.BucketEncryption`

Configura el tipo de encriptación.

#### `configureObjectLockRetention(mode string, days int32) awss3.ObjectLockRetention`

Configura retención de Object Lock.

## Mejores Prácticas

### Seguridad

1. **Usar funciones preconfiguradas para casos comunes**

   ```go
   // Recomendado
   props := s3.GetEnterpriseDataProperties()
   props.BucketName = "mi-bucket-12345"

   // En lugar de configuración manual compleja
   ```

2. **Nombres únicos con sufijos**

   ```go
   import "crypto/rand"

   // Generar sufijo único
   props.BucketName = "mi-empresa-data-prod-af3b2c1d"
   ```

3. **Siempre usar encriptación KMS para datos sensibles**

   ```go
   props.Encryption = "KMS"
   props.BucketKeyEnabled = true // Reducir costos
   ```

### Lifecycle Rules Correctas

1. **Usar sintaxis correcta de CDK Go v2**

   ```go
   // Correcto
   &awss3.LifecycleRule{
       Id:      jsii.String("MyRule"),
       Enabled: jsii.Bool(true),
       Prefix:  jsii.String("data/"),
       Transitions: &[]*awss3.Transition{
           {
               StorageClass:    awss3.StorageClass_GLACIER(), // Función con ()
               TransitionAfter: awscdk.Duration_Days(jsii.Number(90)),
           },
       },
       Expiration: awscdk.Duration_Days(jsii.Number(2555)),
   }
   ```

2. **Storage Classes disponibles**

   ```go
   awss3.StorageClass_STANDARD()
   awss3.StorageClass_INFREQUENT_ACCESS()
   awss3.StorageClass_GLACIER()
   awss3.StorageClass_DEEP_ARCHIVE()
   awss3.StorageClass_INTELLIGENT_TIERING()
   ```

### Costos

1. **Intelligent Tiering para patrones inciertos**

   ```go
   props.EnableIntelligentTiering = true
   props.TransitionMinimumSize = "ALL_STORAGE_CLASSES_128_K"
   ```

2. **Lifecycle rules específicas por prefijo**

   ```go
   // Para datos de diferente criticidad
   rawDataRule := &awss3.LifecycleRule{
       Id:     jsii.String("RawDataLifecycle"),
       Prefix: jsii.String("raw-data/"),
       // Transición más lenta
   }

   processedRule := &awss3.LifecycleRule{
       Id:     jsii.String("ProcessedDataLifecycle"),
       Prefix: jsii.String("processed/"),
       // Transición más rápida
   }
   ```

### Monitoreo

1. **Métricas específicas por funcionalidad**

   ```go
   props.EnableMetrics = true
   props.MetricsPrefix = "critical-data/" // Solo datos críticos
   props.MetricsTagFilters = map[string]string{
       "Environment": "Production",
       "DataClass":   "Sensitive",
   }
   ```

2. **EventBridge para automatización**

   ```go
   props.EventBridgeEnabled = true
   // Integra con Lambda, Step Functions, etc.
   ```

## Ejemplos Avanzados

### Pipeline de Procesamiento de Datos

```go
// 1. Bucket de ingesta
ingestion := s3.GetDefaultProperties()
ingestion.BucketName = "data-ingestion-raw-12345"
ingestion.EventBridgeEnabled = true // Trigger procesamiento
ingestion.LifecycleRules = []*awss3.LifecycleRule{
    {
        Id:      jsii.String("FastProcessing"),
        Enabled: jsii.Bool(true),
        Transitions: &[]*awss3.Transition{
            {
                StorageClass:    awss3.StorageClass_INFREQUENT_ACCESS(),
                TransitionAfter: awscdk.Duration_Days(jsii.Number(7)), // Procesamiento rápido
            },
        },
    },
}

// 2. Bucket de datos procesados
processed := s3.GetDataLakeProperties()
processed.BucketName = "data-processed-analytics-12345"
// Ya incluye lifecycle optimizado para analytics

// 3. Bucket de archivo a largo plazo
archive := s3.GetBackupProperties()
archive.BucketName = "data-archive-longterm-12345"
// Ya incluye lifecycle agresivo hacia Deep Archive
```

### Configuración Multi-Región con Replicación

```go
import "fmt"

func CreateMultiRegionSetup(appName, environment string) (primary, replica s3.S3Properties) {
    // Bucket primario (us-east-1)
    primary = s3.GetEnterpriseDataProperties()
    primary.BucketName = fmt.Sprintf("%s-%s-primary-us-east-1", appName, environment)

    // Configurar replicación
    replicaBucketArn := fmt.Sprintf("arn:aws:s3:::%s-%s-replica-us-west-2", appName, environment)
    primary.ReplicationEnabled = true
    primary.ReplicationDestination = replicaBucketArn
    primary.ReplicationStorageClass = "STANDARD_IA"

    // Bucket replica (us-west-2)
    replica = s3.GetEnterpriseDataProperties()
    replica.BucketName = fmt.Sprintf("%s-%s-replica-us-west-2", appName, environment)
    replica.EnableIntelligentTiering = true // Optimización adicional en replica

    return primary, replica
}
```

### Hosting Web Moderno con CloudFront

```go
// RECOMENDADO: S3 + CloudFront con OAC
originBucket := s3.GetCloudFrontOriginProperties()
originBucket.BucketName = "mi-webapp-origin-12345"

// El bucket permanece privado
// CloudFront maneja el acceso público a través de OAC
// SSL/TLS termina en CloudFront
// Logs se capturan en CloudFront, no en S3

// NO RECOMENDADO para producción: hosting directo S3
// websiteBucket := s3.GetStaticWebsiteProperties()
```

---

## Conclusión

Esta documentación refleja la implementación real del código y proporciona patrones probados para casos de uso comunes. Las funciones preconfiguradas eliminan la complejidad de configuración manual mientras mantienen la flexibilidad para personalizaciones específicas.

El enfoque en funciones de utilidad (`GetEnterpriseDataProperties()`, `GetCloudFrontOriginProperties()`, etc.) facilita la adopción de mejores prácticas de AWS sin requerir conocimiento profundo de todas las opciones de configuración.
